<h2>Fetch GitHub data</h2>
<p>Fetches <code>circle-data/circles.json</code> from tag <strong>deploy</strong> and draws circles.</p>
<button id="fetch">Fetch and draw circles</button>
<button id="cancel">Cancel</button>
<p id="status"></p>
<script>
(function () {
  const GITHUB_REPO = "kmnelson/figma-plugin";
  const TAG = "deploy";
  const DATA_PATH = "circle-data/circles.json";

  const url = "https://raw.githubusercontent.com/" + GITHUB_REPO + "/" + TAG + "/" + DATA_PATH;

  function setStatus(text, isError) {
    const el = document.getElementById("status");
    el.textContent = text;
    el.style.color = isError ? "#c00" : "#333";
  }

  document.getElementById("fetch").onclick = function () {
    setStatus("Fetching…");
    console.log("[fetch-github-data] Fetching:", url);
    fetch(url)
      .then(function (res) {
        console.log("[fetch-github-data] Response:", res.status, res.statusText);
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        return res.json();
      })
      .then(function (data) {
        console.log("[fetch-github-data] Parsed data:", data);
        console.log("[fetch-github-data] Is array?", Array.isArray(data), "length:", data && data.length);
        if (data && data.length > 0) {
          console.log("[fetch-github-data] First row:", data[0], "types: x=" + typeof data[0].x + " y=" + typeof data[0].y + " r=" + typeof data[0].r);
        }
        if (!Array.isArray(data)) {
          throw new Error("Expected JSON array of { x, y, r }");
        }
        setStatus("Drawing " + data.length + " circles…");
        console.log("[fetch-github-data] Sending to plugin: type=draw-circles, circles.length=" + data.length);
        parent.postMessage({ pluginMessage: { type: "draw-circles", circles: data } }, "*");
      })
      .catch(function (err) {
        console.error("[fetch-github-data] Error:", err);
        setStatus("Error: " + err.message, true);
      });
  };

  document.getElementById("cancel").onclick = function () {
    parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
  };
})();
</script>
